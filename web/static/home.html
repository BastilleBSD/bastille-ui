{{ define "content" }}

  {{ if .Error }}
    <div class="error">{{ .Error }}</div>
  {{ end }}

  {{ if .Jails }}
    <table class="jails-table">
      <thead>
        <tr>
          <th>
			<input type="checkbox" id="selectAll" />
		  </th>
          <th>JID</th>
          <th>Name</th>
          <th>Boot</th>
          <th>Prio</th>
          <th>State</th>
          <th>Type</th>
          <th>IP</th>
          <th>Published Ports</th>
          <th>Release</th>
          <th>Tags</th>
          <th>Jail Actions</th>
        </tr>
      </thead>

      <tbody>
        {{ range .Jails }}
        <tr>
          <td>
            <input type="checkbox" class="jail-checkbox" value="{{ .Jail.Name }}">
          </td>
          <td>{{ .Jail.JID }}</td>
          <td>{{ .Jail.Name }}</td>
          <td>{{ .Jail.Boot }}</td>
          <td>{{ .Jail.Prio }}</td>
          <td>{{ .Jail.State }}</td>
          <td>{{ .Jail.Type }}</td>
          <td>{{ .Jail.IP }}</td>
          <td>{{ .Jail.Ports }}</td>
          <td>{{ .Jail.Release }}</td>
          <td>{{ .Jail.Tags }}</td>
          <td>
            <button class="homepage-console-button"
                    onclick="openConsole('{{ .Jail.Name }}')">>_</button>

            <form action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" value="{{ .Jail.Name }}">
              <input type="hidden" name="action" value="stop">
              <button type="submit" class="homepage-stop-button">■</button>
            </form>

            <form action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" value="{{ .Jail.Name }}">
              <input type="hidden" name="action" value="start">
              <button type="submit" class="homepage-start-button">▶</button>
            </form>

            <form action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" value="{{ .Jail.Name }}">
              <input type="hidden" name="action" value="restart">
              <button type="submit" class="homepage-restart-button">⟳</button>
            </form>
          </td>
        </tr>
        {{ end }}
      </tbody>

      <!-- BULK ACTIONS -->
      <tfoot>
        <tr>
          <td>
            <form id="multi-jail-form" action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" id="multi-jail-target-input-stop">
              <input type="hidden" name="action" value="stop">
              <button type="submit">Stop</button>
            </form>

            <form id="multi-jail-form-start" action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" id="multi-jail-target-input-start">
              <input type="hidden" name="action" value="start">
              <button type="submit">Start</button>
            </form>

            <form id="multi-jail-form-restart" action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" id="multi-jail-target-input-restart">
              <input type="hidden" name="action" value="restart">
              <button type="submit">Restart</button>
            </form>

            <form id="multi-jail-form-destroy" action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" id="multi-jail-target-input-destroy">
              <input type="hidden" name="action" value="destroy">
              <button type="submit">Destroy</button>

            </form>

            <form id="multi-jail-form-destroy" action="/bastille/quickaction" method="POST">
              <input type="hidden" name="target" id="multi-jail-target-input-destroy">
              <input type="hidden" name="action" value="destroy">
              <button type="submit">Destroy</button>

            </form>
          </td>
        </tr>
      </tfoot>
    </table>

    <!-- Console -->
    <div id="console-overlay" class="console-overlay" onclick="closeConsole()"></div>
    <div id="console-iframe-container">
      <iframe id="consoleIframe" class="console-iframe" frameborder="0"></iframe>
      <button class="console-close-button" onclick="closeConsole()">Close</button>
    </div>

<script>

function openConsole(jail) {
    const url = `/bastille/console?target=` + encodeURIComponent(jail);

    fetch(url, { method: "GET" }) // POST if your API expects it
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.text(); // The API returns the full URL
        })
        .then(url => {
            document.getElementById("consoleIframe").src = url;
            document.getElementById("console-overlay").style.display = "block";
            document.getElementById("console-iframe-container").style.display = "block";
        })
        .catch(err => console.error("Error opening console:", err));
}

function closeConsole() {
    const iframe = document.getElementById("consoleIframe");
    iframe.src = "about:blank"; // stops ttyd stream
    document.getElementById("console-overlay").style.display = "none";
    document.getElementById("console-iframe-container").style.display = "none";
}

function setupBulkForm(formId, inputId, needsConfirm = false) {
    document.getElementById(formId).addEventListener("submit", function (e) {
        const selected = Array.from(
            document.querySelectorAll(".jail-checkbox:checked")
        ).map(cb => cb.value);

        if (selected.length === 0) {
            e.preventDefault();
            alert("Please select at least one jail.");
            return;
        }

        if (needsConfirm) {
            const confirmed = confirm(
                "Are you sure you want to DESTROY the selected jail(s)?\nThis action cannot be undone."
            );
            if (!confirmed) {
                e.preventDefault();
                return;
            }
        }

        document.getElementById(inputId).value = selected.join(" ");
    });
}

// Select All checkbox logic
const selectAllCheckbox = document.getElementById("selectAll");
const jailCheckboxes = document.querySelectorAll(".jail-checkbox");

selectAllCheckbox.addEventListener("change", function () {
    const checked = this.checked;
    jailCheckboxes.forEach(cb => cb.checked = checked);
});

jailCheckboxes.forEach(cb =>
    cb.addEventListener("change", function () {
        if (!this.checked) {
            selectAllCheckbox.checked = false;
        } else if (Array.from(jailCheckboxes).every(cb => cb.checked)) {
            selectAllCheckbox.checked = true;
        }
    })
);

// Bulk action setups
setupBulkForm("multi-jail-form", "multi-jail-target-input-stop");
setupBulkForm("multi-jail-form-start", "multi-jail-target-input-start");
setupBulkForm("multi-jail-form-restart", "multi-jail-target-input-restart");
setupBulkForm("multi-jail-form-destroy", "multi-jail-target-input-destroy", true);

</script>

  {{ end }}
{{ end }}
