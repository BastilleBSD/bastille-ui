{{ define "content" }}

{{ if .Error }}
  <div class="error-banner">{{ .Error }}</div>
{{ end }}

{{ if .Jails }}

<div class="home-header">
  <div class="home-header-main">
    <label class="home-select-all">
      <input type="checkbox" id="selectAll" />
      <span>Select All</span>
    </label>

    <div class="bulk-btn-group">
      <button class="ghost-btn" onclick="bulkAction('stop')">STOP</button>
      <button class="ghost-btn" onclick="bulkAction('start')">START</button>
      <button class="ghost-btn danger" onclick="bulkAction('destroy')">DESTROY</button>
    </div>
  </div>
</div>

<div class="jails-grid">
  {{ range .Jails }}
  <div class="jail-panel" data-jail="{{ .Jail.Name }}">
    <div class="jail-loading">
      <span class="spinner"></span>
    </div>

    <div class="jail-panel-top">
      <div class="jail-panel-identity">
        <input type="checkbox" class="jail-panel-checkbox" value="{{ .Jail.Name }}">
        <span class="jail-name">{{ .Jail.Name }}</span>
      </div>

      <div class="jail-panel-status-indicator">
        {{ if eq .Jail.State "Up" }}
          <span class="throbber up" title="Active"></span>
        {{ else }}
          <span class="throbber down" title="Inactive"></span>
        {{ end }}
      </div>
    </div>

    <div class="jail-panel-details">
      <div class="detail-row"><span class="d-label">IP</span><span class="d-value">{{ .Jail.IP }}</span></div>
      <div class="detail-row"><span class="d-label">Release</span><span class="d-value">{{ .Jail.Release }}</span></div>
      <div class="detail-row"><span class="d-label">Type</span><span class="d-value">{{ .Jail.Type }}</span></div>
      <div class="detail-row"><span class="d-label">Priority</span><span class="d-value">{{ .Jail.Prio }}</span></div>
      <div class="detail-row"><span class="d-label">Boot</span><span class="d-value">{{ .Jail.Boot }}</span></div>
    </div>

    <div class="jail-panel-actions">
      <button
        type="button"
        class="jail-panel-console-button"
        onclick="openConsole('{{ .Jail.Name }}')"
        title="Console">>_</button>

      <div class="jail-panel-btn-cluster">
        <button class="jail-panel-start-button" type="button" onclick="jailAction('start', '{{ .Jail.Name }}')">▶</button>
        <button class="jail-panel-stop-button" type="button" onclick="jailAction('stop', '{{ .Jail.Name }}')">■</button>
        <button class="jail-panel-restart-button" type="button" onclick="jailAction('restart', '{{ .Jail.Name }}')">⟳</button>
      </div>
    </div>
  </div>
  {{ end }}
</div>

<div id="console-overlay" class="console-overlay" onclick="closeConsole()"></div>
<div id="console-iframe-container" class="console-ifram-container">
  <iframe id="consoleIframe" class="console-iframe"></iframe>
  <button class="console-close-button" onclick="closeConsole()">CLOSE</button>
</div>

<script>
async function jailAction(action, target) {
  const panel = document.querySelector(`.jail-panel[data-jail="${target}"]`);
  if (!panel) return;

  panel.classList.add("loading");

  try {
    const res = await fetch("/bastille/quickaction", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ action, target })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || "Action failed");
    }

    const listRes = await fetch("/bastille/quickaction/list-jails-json");
    if (!listRes.ok) throw new Error("Failed to fetch jail list");

    const jails = await listRes.json();
    if (!Array.isArray(jails)) throw new Error("Invalid jail list");

    const updated = jails.find(j => j.Jail?.Name === target);
    if (!updated) {
      console.warn("Updated jail not found:", target);
      return;
    }

    updateJailPanel(panel, updated.Jail);

  } catch (err) {
    alert(err.message);
  } finally {
    panel.classList.remove("loading");
  }
}
// ================= BULK ACTION =================
async function bulkAction(action) {
  const targets = Array.from(
    document.querySelectorAll(".jail-panel-checkbox:checked")
  ).map(c => c.value);

  if (!targets.length) {
    alert("SELECT JAILS FIRST.");
    return;
  }

  targets.forEach(t => 
    document.querySelector(`.jail-panel[data-jail="${t}"]`)?.classList.add("loading")
  );

  try {
    const res = await fetch("/bastille/quickaction", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ action, target: targets.join(" ") })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || "Bulk action failed");
    }

    // Fetch updated jail list
    const listRes = await fetch("/bastille/quickaction/list-jails-json");
    const jails = await listRes.json();

    targets.forEach(t => {
      const panel = document.querySelector(`.jail-panel[data-jail="${t}"]`);
      const updated = jails.find(j => j.Jail.Name === t);
      if (panel && updated) updateJailPanel(panel, updated.Jail);
    });

  } catch (err) {
    alert(err.message);
  } finally {
    targets.forEach(t => 
      document.querySelector(`.jail-panel[data-jail="${t}"]`)?.classList.remove("loading")
    );
  }
}

function updateJailPanel(panel, jail) {
  const throbber = panel.querySelector(".jail-panel-status-indicator span");
  if (throbber) {
    if (jail.State === "Up") {
      throbber.className = "throbber up";
      throbber.title = "Active";
    } else {
      throbber.className = "throbber down";
      throbber.title = "Inactive";
    }
  }

  const details = panel.querySelectorAll(".jail-panel-details .d-value");
  if (details.length >= 5) {
    details[0].textContent = jail.IP || "";
    details[1].textContent = jail.Release || "";
    details[2].textContent = jail.Type || "";
    details[3].textContent = jail.Prio || "";
    details[4].textContent = jail.Boot || "";
  }
}

function openConsole(jail) {
  // Show a loading state or just trigger the fetch
  fetch(`/bastille/console`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ target: jail })
  })
    .then(res => {
      if (!res.ok) throw new Error("Could not start console session");
      return res.text();
    })
    .then(url => {
      // url should be the full http://IP:PORT from your Go backend
      const iframe = document.getElementById("consoleIframe");
      iframe.src = url;
      
      document.getElementById("console-iframe-container").style.display = "block";
      document.getElementById("console-overlay").style.display = "block";
    })
    .catch(err => {
      alert("Console Error: " + err.message);
    });
}

function closeConsole() {
  document.getElementById("consoleIframe").src = "about:blank";
  document.getElementById("console-iframe-container").style.display = "none";
  document.getElementById("console-overlay").style.display = "none";
}

// ================= SELECT ALL =================
document.getElementById("selectAll").onclick = function () {
  document.querySelectorAll(".jail-panel-checkbox")
    .forEach(c => c.checked = this.checked);
};

</script>

{{ end }}
{{ end }}
